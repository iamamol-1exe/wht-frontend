"use client";

import React, {
  useCallback,
  useEffect,
  useMemo,
  useRef,
  useState,
} from "react";
import Image from "next/image";
import {
  Image as ImageIcon,
  Lock,
  Send,
  SmilePlus,
  UserPlus,
  Settings,
  MoreVertical,
  Phone,
  Video,
  Search,
  Pin,
  Bell,
  Moon,
  Sun,
} from "lucide-react";

import { Button } from "@/components/ui/button";
import {
  Card,
  CardAction,
  CardContent,
  CardDescription,
  CardFooter,
  CardHeader,
  CardTitle,
} from "@/components/ui/card";
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import { EncryptedText } from "@/components/ui/encrypted-text";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { BackgroundBeams } from "@/components/ui/background-beams";
import { cn } from "@/lib/utils";

type Chat = {
  id: string;
  title: string;
  subtitle?: string;
  lastActiveAt: string;
  avatar: string;
  isOnline: boolean;
  unreadCount?: number;
  isPinned?: boolean;
  lastMessage?: string;
};

type Message =
  | {
      id: string;
      from: "me" | "them";
      kind: "text";
      text: string;
      at: string;
      senderName?: string;
      senderAvatar?: string;
    }
  | {
      id: string;
      from: "me" | "them";
      kind: "image";
      alt: string;
      objectUrl: string;
      at: string;
      senderName?: string;
      senderAvatar?: string;
    }
  | {
      id: string;
      from: "me" | "them";
      kind: "sticker";
      sticker: string;
      at: string;
      senderName?: string;
      senderAvatar?: string;
    };

const STICKERS: Array<{ label: string; value: string }> = [
  { label: "Wave", value: "üëã" },
  { label: "Smile", value: "üòÑ" },
  { label: "Hearts", value: "ü´∂" },
  { label: "Fire", value: "üî•" },
  { label: "LOL", value: "üòÇ" },
  { label: "Cool", value: "üòé" },
  { label: "Star", value: "‚≠ê" },
  { label: "Rocket", value: "üöÄ" },
];

function nowTime(): string {
  return new Date().toLocaleTimeString([], {
    hour: "2-digit",
    minute: "2-digit",
  });
}

function makeId(prefix: string): string {
  return `${prefix}_${Math.random().toString(16).slice(2)}_${Date.now()}`;
}

export default function DashboardPage() {
  const fileInputRef = useRef<HTMLInputElement | null>(null);
  const messagesEndRef = useRef<HTMLDivElement | null>(null);

  const [search, setSearch] = useState("");
  const [startChatWith, setStartChatWith] = useState("");

  const [chats, setChats] = useState<Chat[]>(() => [
    {
      id: "c_1",
      title: "Aarav Sharma",
      subtitle: "typing...",
      lastActiveAt: "now",
      avatar: "AS",
      isOnline: true,
      unreadCount: 2,
      isPinned: true,
      lastMessage: "Hey! This chat is end-to-end encrypted.",
    },
    {
      id: "c_2",
      title: "Dev Team",
      subtitle: "3 members",
      lastActiveAt: "2m",
      avatar: "DT",
      isOnline: true,
      unreadCount: 5,
      isPinned: true,
      lastMessage: "Reminder: standup in 10 mins.",
    },
    {
      id: "c_3",
      title: "Support",
      subtitle: "last seen 1h ago",
      lastActiveAt: "1h",
      avatar: "SU",
      isOnline: false,
      lastMessage: "How can we help you today?",
    },
    {
      id: "c_4",
      title: "Priya Patel",
      subtitle: "online",
      lastActiveAt: "5m",
      avatar: "PP",
      isOnline: true,
      lastMessage: "Thanks for the update!",
    },
    {
      id: "c_5",
      title: "Project Alpha",
      subtitle: "12 members",
      lastActiveAt: "15m",
      avatar: "PA",
      isOnline: true,
      unreadCount: 8,
      lastMessage: "@everyone New deployment is live",
    },
  ]);
  const [activeChatId, setActiveChatId] = useState<string>("c_1");
  const activeChat = useMemo(
    () => chats.find((c) => c.id === activeChatId) ?? chats[0],
    [activeChatId, chats]
  );

  const [draft, setDraft] = useState<string>("");
  const [pendingFiles, setPendingFiles] = useState<File[]>([]);
  const [messages, setMessages] = useState<Record<string, Message[]>>(() => ({
    c_1: [
      {
        id: "m_1",
        from: "them",
        kind: "text",
        text: "Hey! This chat is end-to-end encrypted.",
        at: "09:14",
        senderName: "Aarav Sharma",
        senderAvatar: "AS",
      },
      {
        id: "m_2",
        from: "me",
        kind: "text",
        text: "Nice. I can also share images and stickers here.",
        at: "09:15",
        senderName: "You",
        senderAvatar: "YU",
      },
      {
        id: "m_3",
        from: "them",
        kind: "text",
        text: "That's awesome! The UI looks really clean.",
        at: "09:15",
        senderName: "Aarav Sharma",
        senderAvatar: "AS",
      },
      {
        id: "m_4",
        from: "me",
        kind: "text",
        text: "Thanks! Working on making it even better.",
        at: "09:16",
        senderName: "You",
        senderAvatar: "YU",
      },
    ],
    c_2: [
      {
        id: "m_3",
        from: "them",
        kind: "text",
        text: "Reminder: standup in 10 mins.",
        at: "08:58",
        senderName: "Dev Team",
        senderAvatar: "DT",
      },
    ],
    c_3: [
      {
        id: "m_4",
        from: "them",
        kind: "text",
        text: "How can we help you today?",
        at: "Yesterday",
        senderName: "Support",
        senderAvatar: "SU",
      },
    ],
  }));

  const activeMessages = messages[activeChatId] ?? [];

  const filteredChats = useMemo(() => {
    const q = search.trim().toLowerCase();
    if (!q) return chats;
    return chats.filter(
      (c) =>
        c.title.toLowerCase().includes(q) ||
        (c.subtitle ?? "").toLowerCase().includes(q)
    );
  }, [chats, search]);

  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
  }, [activeChatId, activeMessages.length]);

  const openFilePicker = useCallback(() => {
    fileInputRef.current?.click();
  }, []);

  const onPickFiles = useCallback((files: FileList | null) => {
    if (!files || files.length === 0) return;
    const next: File[] = [];
    for (const file of Array.from(files)) {
      if (file.type.startsWith("image/")) next.push(file);
    }
    if (next.length === 0) return;
    setPendingFiles((prev) => [...prev, ...next]);
  }, []);

  const removePendingFile = useCallback((index: number) => {
    setPendingFiles((prev) => prev.filter((_, i) => i !== index));
  }, []);

  const sendSticker = useCallback(
    (sticker: string) => {
      if (!activeChatId) return;
      const msg: Message = {
        id: makeId("st"),
        from: "me",
        kind: "sticker",
        sticker,
        at: nowTime(),
      };
      setMessages((prev) => ({
        ...prev,
        [activeChatId]: [...(prev[activeChatId] ?? []), msg],
      }));
    },
    [activeChatId]
  );

  const send = useCallback(() => {
    if (!activeChatId) return;
    const text = draft.trim();
    const hasText = text.length > 0;
    const hasFiles = pendingFiles.length > 0;
    if (!hasText && !hasFiles) return;

    const nextMessages: Message[] = [];

    if (hasText) {
      nextMessages.push({
        id: makeId("tx"),
        from: "me",
        kind: "text",
        text,
        at: nowTime(),
      });
    }

    for (const file of pendingFiles) {
      const objectUrl = URL.createObjectURL(file);
      nextMessages.push({
        id: makeId("im"),
        from: "me",
        kind: "image",
        objectUrl,
        alt: file.name,
        at: nowTime(),
      });
    }

    setMessages((prev) => ({
      ...prev,
      [activeChatId]: [...(prev[activeChatId] ?? []), ...nextMessages],
    }));
    setDraft("");
    setPendingFiles([]);
  }, [activeChatId, draft, pendingFiles]);

  // Cleanup object URLs when leaving page.
  useEffect(() => {
    return () => {
      for (const chatId of Object.keys(messages)) {
        for (const msg of messages[chatId] ?? []) {
          if (msg.kind === "image") URL.revokeObjectURL(msg.objectUrl);
        }
      }
    };
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  const startChat = useCallback(
    (e: React.FormEvent) => {
      e.preventDefault();
      const target = startChatWith.trim();
      if (!target) return;
      const id = makeId("c");
      const initials = target
        .split(" ")
        .map((n) => n[0])
        .join("")
        .toUpperCase()
        .slice(0, 2);
      const chat: Chat = {
        id,
        title: target,
        subtitle: "New chat",
        lastActiveAt: "now",
        avatar: initials,
        isOnline: false,
      };
      setChats((prev) => [chat, ...prev]);
      setMessages((prev) => ({ ...prev, [ bg-background">
      <BackgroundBeams className="opacity-20" />

      <div className="relative mx-auto flex min-h-screen w-full max-w-7xl">
        {/* Sidebar */}
        <div className="hidden w-20 border-r bg-card/50 backdrop-blur-sm lg:flex lg:flex-col lg:items-center lg:gap-4 lg:py-4">
          <div className="flex size-12 items-center justify-center rounded-xl bg-primary text-primary-foreground font-bold text-lg">
            W
          </div>
          <div className="flex-1" />
          <Button variant="ghost" size="icon" className="rounded-xl">
            <Settings className="size-5" />
          </Button>
          <div className="flex size-10 items-center justify-center rounded-full bg-gradient-to-br from-purple-500 to-pink-500 text-white font-semibold text-sm">
            YU
          </div>
        </div>

        {/* Chat List */}
        <div className="w-full border-r bg-card/30 backdrop-blur-sm md:w-96">
          <div className="flex h-16 items-center justify-between border-b px-4">
            <h1 className="text-xl font-bold">WhaTube</h1>
            <div className="flex items-center gap-1">
              <Button variant="ghost" size="icon" className="size-9">
                <Search className="size-4" />
              </Button>
              <DropdownMenu>
                <DropdownMenuTrigger asChild>
                  <Button variant="ghost" size="icon" className="size-9">
                    <MoreVertical className="size-4" />
                  </Button>
                </DropdownMenuTrigger>
                <DropdownMenuContent align="end">
                  <DropdownMenuItem>
                    <Settings className="mr-2 size-4" />
                    Settings
                  </DropdownMenuItem>
                  <DropdownMenuItem>
                    <Bell className="mr-2 size-4" />
                    Notifications
                  </DropdownMenuItem>
                  <DropdownMenuSeparator />
                  <DropdownMenuItem>
                    <Moon className="mr-2 size-4" />
                    Dark Mode
                  </DropdownMenuItem>
                </DropdownMenuContent>
              </DropdownMenu>
            </div>
          </div>

          <div className="border-b p-3">
            <Input
              placeholder="Search chats..."
              value={search}
              onChange={(e) => setSearch(e.target.value)}
              className="h-9"
            />
          </div>

          <div className="h-[calc(100vh-9rem)] overflow-y-auto">
            {filteredChats.map((c) => {
              const active = c.id === activeChatId;
              return (
                <button
                  key={c.id}
                  type="button"
                  onClick={() => setActiveChatId(c.id)}
                  className={cn(
                    "flex w-full items-center gap-3 border-b px-4 py-3 text-left transition-colors hover:bg-accent/50",
                    active && "bg-accent"
                  )}
                >
                  <div className="relative">
                    <div
                      className={cn(
                        "flex size-12 items-center justify-center rounded-full font-semibold text-sm",
                        active
                          ? "bg-primary text-primary-foreground"
                          : "bg-gradient-to-br from-blue-500 to-purple-500 text-white"
                      )}
                    >
                      {c.avatar}
                    </div>
                    {c.isOnline && (
                      <div className="absolute bottom-0 right-0 size-3.5 rounded-full border-2 border-background bg-green-500" />
                    )}
                    {c.isPinned && (
                      <div className="absolute -right-1 -top-1">
                        <Pin className="size-3.5 fill-primary text-primary" />
                      </div>
                    )}
                  </div>
                  <div className="min-w-0 flex-1">
                    <div className="flex items-center justify-between gap-2">
                      <div className="truncate font-semibold text-sm">
                        {c.title}
                      </div>
                      <div className="shrink-0 text-xs text-muted-foreground">
                        {c.lastActiveAt}
                      </div>
                    </div>
                    <div className="mt-0.5 flex items-center justify-between gap-2">
                      <div className="truncate text-sm text-muted-foreground">
                        {c.lastMessage ?? c.subtitle ?? ""}
                      </div>
                      {c.unreadCount && c.unreadCount > 0 && (
                        <div className="flex size-5 shrink-0 items-center justify-center rounded-full bg-primary text-[11px] font-semibold text-primary-foreground">
                          {c.unreadCount}
                        </div>
                      )}
                    </div>
                  </div>
                </button>
        {/* Main Chat Area */}
        <div className="flex flex-1 flex-col bg-background/50 backdrop-blur-sm">
          {/* Chat Header */}
          <div className="flex h-16 items-center justify-between border-b bg-card/50 px-4 backdrop-blur-sm">
            <div className="flex items-center gap-3">
              <div className="relative">
                <div className="flex size-10 items-center justify-center rounded-full bg-gradient-to-br from-blue-500 to-purple-500 font-semibold text-white text-sm">
                  {activeChat?.avatar}
                </div>
                {activeChat?.isOnline && (
                  <div className="absolute bottom-0 right-0 size-3 rounded-full border-2 border-background bg-green-500" />
                )}
              </div>
              <div>
                <div className="font-semibold text-sm">
                  {activeChat?.title ?? "Select a chat"}
                </div>
                <div className="flex items-center gap-1.5 text-xs text-muted-foreground">
                  <Lock className="size-3" />
                  <span>{activeChat?.subtitle ?? "Encrypted"}</span>
                </div>
              </div>
            </div>
            <div className="flex items-center gap-1">
              <Button variant="ghost" size="icon" className="size-9">
                <Phone className="size-4" />
              </Button>
              <Button variant="ghost" size="icon" className="size-9">
                <Video className="size-4" />
              </Button>
              <Button variant="ghost" size="icon" className="size-9">
                <Search className="size-4" />
              </Button>
              <DropdownMenu>
                <DropdownMenuTrigger asChild>
                  <Button variant="ghost" size="icon" className="size-9">
                    <MoreVertical className="size-4" />
                  </Button>
                </DropdownMenuTrigger>
                <DropdownMenuContent align="end">
                  <DropdownMenuItem>View Profile</DropdownMenuItem>
                  <DropdownMenuItem>Mute Notifications</DropdownMenuItem>
                  <DropdownMenuSeparator />
                  <DropdownMenuItem>Clear History</DropdownMenuItem>
                  <DropdownMenuItem className="text-destructive">
                    Delete Chat
                  </DropdownMenuItem>
                </DropdownMenuContent>
              </DropdownMenu>
            </div>
          </div>

          {/* Messages */}
          <div className="flex-1 overflow-y-auto p-4">
            {activeMessages.length === 0 ? (
              <div className="flex h-full items-center justify-center">
                <div className="text-center">
                  <div className="mb-3 flex size-16 items-center justify-center rounded-full bg-primary/10 mx-auto">
                    <Lock className="size-8 text-primary" />
                  </div>
                  <h3 className="mb-2 font-semibold text-lg">
                    End-to-End Encrypted
                  </h3>
                  <p className="max-w-md text-muted-foreground text-sm">
                    Messages are secured with end-to-end encryption. Start the
                    conversation now.
                  </p>
                </div>
              </div>
            ) : (
              <div className="mx-auto max-w-4xl space-y-4">
                {activeMessages.map((m, idx) => {
                  const mine = m.from === "me";
                  const prevMsg = idx > 0 ? activeMessages[idx - 1] : null;
                  const showAvatar =
                    !mine && (!prevMsg || prevMsg.from !== m.from);

                  return (
                    <div
                      key={m.id}
                      className={cn(
                        "flex gap-2",
                        mine ? "flex-row-reverse" : "flex-row",
                        !showAvatar && !mine && "ml-10"
                      )}
                    >
                      {!mine && showAvatar && (
                        <div className="flex size-8 shrink-0 items-center justify-center rounded-full bg-gradient-to-br from-blue-500 to-purple-500 font-semibold text-white text-xs">
                          {m.senderAvatar}
                        </div>
                      )}
                      {!mine && !showAvatar && <div className="w-8 shrink-0" />}

                      <div
                        className={cn(
                          "group relative max-w-[65%]",
                          mine && "flex flex-col items-end"
                        )}
                      >
                        {!mine && showAvatar && (
                          <div className="mb-1 ml-1 font-medium text-xs text-muted-foreground">
                            {m.senderName}
                          </div>
                        )}
                        <div
                          className={cn(
                            "rounded-2xl px-4 py-2 shadow-sm",
                            mine
                              ? "rounded-br-md bg-primary text-primary-foreground"
                              : "rounded-bl-md bg-card"
                          )}
                        >
                          {m.kind === "text" && (
                            <div className="whitespace-pre-wrap break-words text-[15px] leading-relaxed">
                              {m.text}
                            </div>
                          )}
                          {m.kind === "sticker" && (
                            <div className="text-5xl leading-none">
                              {m.sticker}
                            </div>
                          )}
                          {m.kind === "image" && (
                            <div className="flex flex-col gap-2">
                              <Image
                                src={m.objectUrl}
                                alt={m.alt}
                                width={640}
                                height={640}
                                unoptimized
                                className="max-h-80 w-auto rounded-xl"
                                sizes="(max-width: 768px) 80vw, 500px"
                              />
                              <div
                                className={cn(
                                  "text-xs",
                                  mine
                                    ? "text-primary-foreground/70"
                                    : "text-muted-foreground"
                                )}
                              >
                                {m.alt}
                              </div>
                            </div>
                          )}
                        </div>
                        <div
                          className={cn(
                            "mt-1 px-1 text-[11px] text-muted-foreground",
                            mine && "text-right"
                          )}
                        >
                          {m.at}
                        </div>
                      </div>
                    </div>
                  );
                })}
                <div ref={messagesEndRef} />
              </div>
            )}
          </div>

          {/* Message Input */}
          <div className="border-t bg-card/50 p-4 backdrop-blur-sm">
            {pendingFiles.length > 0 && (
              <div className="mb-3 flex flex-wrap gap-2">
                {pendingFiles.map((f, idx) => (
                  <div
                    key={`${f.name}_${idx}`}
                    className="flex items-center gap-2 rounded-lg border bg-background px-3 py-2"
                  >
                    <ImageIcon className="size-4 text-muted-foreground" />
                    <span className="max-w-40 truncate text-sm">{f.name}</span>
                    <button
                      type="button"
                      onClick={() => removePendingFile(idx)}
                      className="ml-1 text-muted-foreground hover:text-foreground"
                      aria-label="Remove image"
                    >
                      √ó
                    </button>
                  </div>
                ))}
              </div>
            )}

            <div className="flex items-end gap-2">
              <input
                ref={fileInputRef}
                type="file"
                accept="image/*"
                multiple
                className="hidden"
                onChange={(e) => onPickFiles(e.target.files)}
              />

              <Button
                type="button"
                variant="ghost"
                size="icon"
                onClick={openFilePicker}
                className="size-10 shrink-0"
                aria-label="Attach image"
              >
                <ImageIcon className="size-5" />
              </Button>

              <DropdownMenu>
                <DropdownMenuTrigger asChild>
                  <Button
                    type="button"
                    variant="ghost"
                    size="icon"
                    className="size-10 shrink-0"
                    aria-label="Stickers"
                  >
                    <SmilePlus className="size-5" />
                  </Button>
                </DropdownMenuTrigger>
                <DropdownMenuContent align="start" className="w-56">
                  <DropdownMenuLabel>Send Sticker</DropdownMenuLabel>
                  <DropdownMenuSeparator />
                  <div className="grid grid-cols-4 gap-1 p-2">
                    {STICKERS.map((s) => (
                      <button
                        key={s.value}
                        type="button"
                        onClick={() => {
                          if (draft.trim().length > 0) {
                            setDraft(
                              (prev) =>
                                `${prev}${
                                  prev.endsWith(" ") || prev.length === 0
                                    ? ""
                                    : " "
                                }${s.value} `
                            );
                            return;
                          }
                          sendSticker(s.value);
                        }}
                        className="flex size-12 items-center justify-center rounded-lg text-2xl transition-colors hover:bg-accent"
                        title={s.label}
                      >
                        {s.value}
                      </button>
                    ))}
                  </div>
                </DropdownMenuContent>
              </DropdownMenu>

              <div className="flex-1">
                <Textarea
                  value={draft}
                  onChange={(e) => setDraft(e.target.value)}
                  placeholder="Type a message..."
                  className="min-h-[44px] max-h-32 resize-none rounded-2xl"
                  onKeyDown={(e) => {
                    if (e.key === "Enter" && !e.shiftKey) {
                      e.preventDefault();
                      send();
                    }
                  }}
                />
              </div>

              <Button
                type="button"
                onClick={send}
                size="icon"
                className="size-10 shrink-0 rounded-full"
                aria-label="Send"
              >
                <Send className="size-5" />
              </Button>
            </div>
          </div        >
                          <span className="text-lg">{s.value}</span>
                          <span className="text-sm">{s.label}</span>
                        </DropdownMenuItem>
                      ))}
                    </DropdownMenuContent>
                  </DropdownMenu>

                  <div className="flex-1">
                    <Textarea
                      value={draft}
                      onChange={(e) => setDraft(e.target.value)}
                      placeholder="Write a message‚Ä¶"
                      className="min-h-10"
                      onKeyDown={(e) => {
                        if (e.key === "Enter" && !e.shiftKey) {
                          e.preventDefault();
                          send();
                        }
                      }}
                    />
                    <div className="mt-1 text-xs text-muted-foreground">
                      Press Enter to send ‚Ä¢ Shift+Enter for new line
                    </div>
                  </div>

                  <Button type="button" onClick={send} aria-label="Send">
                    <Send className="size-4" />
                  </Button>
                </div>
              </div>
            </CardFooter>
          </Card>
        </div>
      </div>
    </div>
  );
}
